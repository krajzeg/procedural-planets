<html>
	<head>
		<style type="text/css">
			body { background: black; }
		</style>
		<script src="bower_components/underscore/underscore.js"></script>
		<script src="bower_components/gl-matrix/dist/gl-matrix.js"></script>
		<script src="wgl-utils.js"></script>
		<script src="ball.js"></script>

		<script>
			var pause = false;

			window.onload = function() {
				var canvas = document.getElementById('cnv');
				gl = canvas.getContext('webgl');

				gl.clearColor(0, 0, 0, 1);
				gl.clear(gl.COLOR_BUFFER_BIT);	
				gl.viewport(0, 0, canvas.width, canvas.height);			
				gl.disable(gl.DEPTH_TEST);
				gl.enable(gl.CULL_FACE);
        		gl.cullFace(gl.BACK);

				var matPerspective = mat4.create();
				mat4.perspective(matPerspective, 45, canvas.width / canvas.height, 0.1, 100.0);

				// ============== shader setup

				var glu = GLUtils(gl);
				var shader = new glu.ShaderProgram(
					document.getElementById('shader-vertex').innerHTML,
					document.getElementById('shader-fragment').innerHTML
				);
				shader.use();

        		// =============== create a ball

        		var mesh = createBallMesh(1, 50, 50);

        		/*var vertices = [-1,-1,0, 1,-1,0, 0,1,0];
        		var colors = [1,0,0, 1,1,0, 0,0.5,1];*/

        		var posBuffer = new glu.Buffer(mesh.vertices, 3, gl.FLOAT);
        		var colorBuffer = new glu.Buffer(mesh.colors, 3, gl.FLOAT);
        		var indexBuffer = new glu.Buffer(mesh.indices, 1, gl.UNSIGNED_SHORT, gl.ELEMENT_ARRAY_BUFFER);

        		// =============== draw!

        		shader.set({
        			mPerspective: matPerspective,

        			aPosition: posBuffer,
        			aColor: colorBuffer,        			
        			uTint: [1,1,1]
        		});

       			var yRotation = 0.0;
       			var matModel = mat4.create();

        		function drawFrame() {
        			if (pause) {
        				return requestAnimationFrame(drawFrame);
        			}

        			yRotation += 0.02;

        			mat4.identity(matModel);
        			mat4.translate(matModel, matModel, [0,0,-4]);
        			mat4.rotateZ(matModel, matModel, -0.2);
        			mat4.rotateY(matModel, matModel, yRotation);

					gl.clear(gl.COLOR_BUFFER_BIT);

        			shader.set({
        				mModel: matModel
        			});
    				glu.drawTriangles(indexBuffer);

    				requestAnimationFrame(drawFrame);
        		};

    			drawFrame();
			};
		</script>

		<script id="shader-vertex" type="x-shader/x-vertex">
			uniform mat4 mPerspective;
			uniform mat4 mModel;

			attribute vec3 aPosition;
			attribute vec3 aColor;

			varying vec3 vColor;

			void main(void) {
				vColor = aColor;				
        		gl_Position = mPerspective * mModel * vec4(aPosition, 1.0);
			}
		</script>

		<script id="shader-fragment" type="x-shader/x-fragment">
			precision mediump float;			
			varying vec3 vColor;

			uniform vec3 uTint;

			void main(void) {
				gl_FragColor = vec4(uTint * vColor, 1.0);
			}
		</script>

	</head>
	<body>
		<canvas id="cnv" width="640" height="640"></canvas>
	</body>
</html>